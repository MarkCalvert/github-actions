# @generated - This file is generated by github.com/dpc-sdp/sdp-ansible-upgrade
---
docker-compose-yaml: docker-compose.yml

project: content-firerescue-vic-gov-au

tasks:
  pre-rollout:
    - run:
        name: Backup DB.
        command: |
          if [[ "$LAGOON_ENVIRONMENT_TYPE" == "production" ]]; then
            ./scripts/drupal/backup.sh
          fi
        service: cli
  post-rollout:
    - run:
        name: env variables
        command: env
        service: cli
    - run:
        name: Import DB.
        command: |
          if [[ "$LAGOON_ENVIRONMENT_TYPE" != "production" ]]; then
            if [[ -z "$PERSIST_DB" ]]; then
              ./scripts/drush-download-db.sh
              ./scripts/drupal/import-db.sh
            fi
          fi
        service: cli
    - run:
        name: Flush Redis.
        command: |
          redis-cli flushall
        service: redis
    - run:
        name: Update the environment base domains.
        command: |
          if [[ "$LAGOON_GIT_BRANCH" != "production" ]]; then
            if [[ -z "$PERSIST_DB" ]]; then
              drush tide-si-domup
            fi
          fi
        service: cli
        shell: bash
    - run:
        name: Deploy drupal.
        command: |
          if [[ "$INSTALL_NEW_SITE" = "1" ]]; then
          ./scripts/drupal/install-new-site.sh
          else
          ./scripts/drupal/deploy.sh
          fi
        service: cli
    - run:
        name: Generate OAuth keys from environment variables.
        command: "drush tide-oauth:keygen"
        service: cli
    - run:
        name: Post deployed URL to JIRA
        command: |
          if [[ "$LAGOON_ENVIRONMENT_TYPE" != "production" ]]; then
            . scripts/jira-post-comment.sh $JIRA_ENDPOINT $JIRA_USERNAME $JIRA_PASSWORD $LAGOON_PR_HEAD_BRANCH $LAGOON_ROUTE "$LAGOON_PR_TITLE"
          fi
        service: cli
    - run:
        name: Trigger Backend E2E or Smoke Testing
        command: "./scripts/trigger-e2e.sh"
        service: cli

environments:
  production:
    cronjobs:
      - name: drush cron
        schedule: "*/15 * * * *"
        command: "drush cron"
        service: cli
      - name: drush cron purge
        schedule: "* * * * *"
        command: "./scripts/drupal/truncate-purge-queue.sh"
        service: cli
      - name: drush scheduled queuing cron
        schedule: "*/2 * * * *"
        command: "drush scheduled-transitions:queue-jobs"
        service: cli
      - name: drush scheduled updates cron
        schedule: "*/2 * * * *"
        command: "drush queue:run scheduled_transition_job"
        service: cli
      - name: Send Tide Workflow Notifications
        schedule: "*/5 * * * *"
        command: "drush queue-run queue_mail --time-limit=240"
        service: cli
      - name: Recreate all entity usage statistics
        schedule: "M 15 * * *"
        command: "drush eu-r --use-queue --multi-pass"
        service: cli
      - name: Trigger database container image build
        schedule: "M 3 * * 1"
        command: "/bay/db-build.sh"
        service: cli

  uat:
    cronjobs:
      - name: drush cron
        schedule: "*/15 * * * *"
        command: "drush cron"
        service: cli
      - name: drush cron purge
        schedule: "* * * * *"
        command: "./scripts/drupal/truncate-purge-queue.sh"
        service: cli
      - name: drush scheduled queuing cron
        schedule: "*/2 * * * *"
        command: "drush scheduled-transitions:queue-jobs"
        service: cli
      - name: drush scheduled updates cron
        schedule: "*/2 * * * *"
        command: "drush queue:run scheduled_transition_job"
        service: cli
      - name: Send Tide Workflow Notifications
        schedule: "*/5 * * * *"
        command: "drush queue-run queue_mail --time-limit=240"
        service: cli

    routes:
      - nginx-php:
          - "uat.content.frv.vic.gov.au":
              tls-acme: "false"
              insecure: Allow
              hsts: max-age=31536000
              annotations:
                nginx.ingress.kubernetes.io/server-snippet: add_header X-Robots-Tag "noindex, nofollow";

                bay.sdp.vic.gov.au/section-io-environment: Uat
                bay.sdp.vic.gov.au/section-io-application: "www.frv.vic.gov.au"

  master:
    cronjobs:
      - name: drush cron
        schedule: "*/15 * * * *"
        command: "drush cron"
        service: cli
      - name: drush cron purge
        schedule: "* * * * *"
        command: "./scripts/drupal/truncate-purge-queue.sh"
        service: cli
      - name: drush scheduled queuing cron
        schedule: "*/2 * * * *"
        command: "drush scheduled-transitions:queue-jobs"
        service: cli
      - name: drush scheduled updates cron
        schedule: "*/2 * * * *"
        command: "drush queue:run scheduled_transition_job"
        service: cli
      - name: Send Tide Workflow Notifications
        schedule: "*/5 * * * *"
        command: "drush queue-run queue_mail --time-limit=240"
        service: cli

    routes:
      - nginx-php:
          - "dev.content.frv.vic.gov.au":
              tls-acme: false
              insecure: Allow
              hsts: max-age=31536000
              annotations:
                nginx.ingress.kubernetes.io/server-snippet: add_header X-Robots-Tag "noindex, nofollow";

                bay.sdp.vic.gov.au/section-io-environment: Master
                bay.sdp.vic.gov.au/section-io-application: "www.frv.vic.gov.au"

  develop:
    cronjobs:
      - name: drush cron
        schedule: "*/15 * * * *"
        command: "drush cron"
        service: cli
      - name: drush cron purge
        schedule: "* * * * *"
        command: "./scripts/drupal/truncate-purge-queue.sh"
        service: cli
      - name: drush scheduled queuing cron
        schedule: "*/2 * * * *"
        command: "drush scheduled-transitions:queue-jobs"
        service: cli
      - name: drush scheduled updates cron
        schedule: "*/2 * * * *"
        command: "drush queue:run scheduled_transition_job"
        service: cli
      - name: Send Tide Workflow Notifications
        schedule: "*/5 * * * *"
        command: "drush queue-run queue_mail --time-limit=240"
        service: cli

    routes:
      - nginx-php:
          - "develop.content.frv.vic.gov.au":
              tls-acme: "false"
              insecure: Allow
              hsts: max-age=31536000
              annotations:
                nginx.ingress.kubernetes.io/server-snippet: add_header X-Robots-Tag "noindex, nofollow";

                bay.sdp.vic.gov.au/section-io-environment: Develop
                bay.sdp.vic.gov.au/section-io-application: "www.frv.vic.gov.au"

production_routes:
  active:
    routes:
      - nginx-php:
          - "content.frv.vic.gov.au":
              tls-acme: "true"
              insecure: Allow
              hsts: max-age=31536000
              annotations:
                bay.sdp.vic.gov.au/section-io-environment: Production
                bay.sdp.vic.gov.au/section-io-application: "www.frv.vic.gov.au"

routes:
  autogenerate:
    insecure: Redirect
